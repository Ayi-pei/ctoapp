# Supabase Auth å®Œæ•´å®¡æŸ¥æŠ¥å‘Š

## ğŸ” **å®¡æŸ¥èŒƒå›´**
å…¨é¢æ£€æŸ¥é¡¹ç›®ä¸­æ‰€æœ‰åŸºäº Supabase Auth çš„ä»£ç æ®µå’Œè¡¨å•ç»“æ„ã€‚

## ğŸš¨ **å‘ç°çš„é—®é¢˜**

### **1. æ•°æ®åº“å±‚é¢ (supabase.sql)**

#### **å·²ä¿®å¤çš„é—®é¢˜**:
- âœ… ç§»é™¤äº†å†²çªçš„ `register_new_user()` å‡½æ•°
- âœ… ç¦ç”¨äº† Supabase Auth è§¦å‘å™¨
- âœ… ç¦ç”¨äº†æ‰€æœ‰ RLS ç­–ç•¥
- âœ… æ³¨é‡Šæ‰äº†æ‰€æœ‰ `auth.uid()` ä¾èµ–çš„ç­–ç•¥

#### **æ®‹ç•™çš„æ³¨é‡Šå’Œæ–‡æ¡£**:
```sql
-- è¿™äº›åªæ˜¯æ³¨é‡Šï¼Œä¸å½±å“åŠŸèƒ½
comment on table public.profiles is 'Stores public user profile information, linked to auth.users.';
-- ç°åœ¨ä½¿ç”¨çº¯è‡ªå®šä¹‰è®¤è¯ï¼Œä¸ä¾èµ– auth.users è¡¨
```

### **2. åº”ç”¨å±‚é¢**

#### **å·²å¼ƒç”¨ä½†ä»å­˜åœ¨çš„æ–‡ä»¶**:
- âŒ `src/context/auth-context.tsx` - å®Œæ•´çš„ Supabase Auth å®ç°
- âŒ `src/context/custom-auth-context.tsx` - æ··åˆè®¤è¯å®ç°
- âŒ `src/app/api/auth/login/route.ts` - æ—§çš„ API è·¯ç”±

#### **éœ€è¦æ›´æ–°çš„ API è·¯ç”±**:
- âŒ `src/app/api/user/assets/route.ts` - ä»ä½¿ç”¨ `supabase.auth.getUser()`

#### **å…¶ä»– Schema æ–‡ä»¶** (æœªä½¿ç”¨ä½†å­˜åœ¨):
- âŒ `src/lib/schema.sql` - åŒ…å«å¤§é‡ `auth.uid()` ç­–ç•¥
- âŒ `src/lib/setup.sql` - åŒ…å« Supabase Auth åˆå§‹åŒ–
- âŒ `src/lib/custom-auth-schema.sql` - è¿‡æ¸¡æ€§æ–‡ä»¶

## âœ… **å·²å®Œæˆçš„ä¿®å¤**

### **1. æ•°æ®åº“å®Œå…¨æ¸…ç†**
```sql
-- ç§»é™¤æ‰€æœ‰ Supabase Auth ä¾èµ–
-- ç¦ç”¨ RLSï¼Œè½¬ä¸ºåº”ç”¨å±‚å®‰å…¨æ§åˆ¶
-- æ³¨é‡Šæ‰æ‰€æœ‰ auth.uid() ç­–ç•¥
```

### **2. API è·¯ç”±æ ‡è®°**
```typescript
// æ ‡è®°éœ€è¦æ›´æ–°çš„ API è·¯ç”±
return NextResponse.json({ error: 'This API route needs to be updated for custom auth.' }, { status: 501 });
```

### **3. ç»Ÿä¸€è®¤è¯ç³»ç»Ÿ**
- âœ… ä½¿ç”¨ `simple-custom-auth.tsx` ä½œä¸ºå”¯ä¸€è®¤è¯ç³»ç»Ÿ
- âœ… åº”ç”¨å±‚å·²å®Œå…¨åˆ‡æ¢åˆ°è‡ªå®šä¹‰è®¤è¯
- âœ… æ‰€æœ‰é¡µé¢å’Œç»„ä»¶éƒ½ä½¿ç”¨ `useSimpleAuth()`

## ğŸ¯ **å½“å‰æ¶æ„çŠ¶æ€**

### **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨**:
- âœ… **è®¤è¯ç³»ç»Ÿ**: `simple-custom-auth.tsx`
- âœ… **æ•°æ®åº“**: `supabase.sql` (å·²æ¸…ç†)
- âœ… **å®‰å…¨æ§åˆ¶**: åº”ç”¨å±‚å®ç°
- âœ… **ä¼šè¯ç®¡ç†**: localStorage + 24å°æ—¶è¿‡æœŸ

### **åºŸå¼ƒä½†ä¿ç•™çš„æ–‡ä»¶**:
è¿™äº›æ–‡ä»¶ä¸å†ä½¿ç”¨ï¼Œä½†ä¿ç•™ä½œä¸ºå‚è€ƒï¼š
- `src/context/auth-context.tsx`
- `src/context/custom-auth-context.tsx`
- `src/lib/schema.sql`
- `src/lib/setup.sql`
- `src/lib/custom-auth-schema.sql`

## ğŸ”§ **éœ€è¦åç»­å¤„ç†çš„é¡¹ç›®**

### **1. API è·¯ç”±æ›´æ–°**
```typescript
// src/app/api/user/assets/route.ts éœ€è¦å®ç°è‡ªå®šä¹‰ä¼šè¯éªŒè¯
function validateCustomSession(sessionToken: string): string | null {
    // å®ç°è‡ªå®šä¹‰ä¼šè¯éªŒè¯é€»è¾‘
    // è¿”å›ç”¨æˆ·IDæˆ–null
}
```

### **2. å¯é€‰çš„æ–‡ä»¶æ¸…ç†**
å¦‚æœç¡®å®šä¸å†éœ€è¦ï¼Œå¯ä»¥åˆ é™¤ï¼š
- `src/context/auth-context.tsx`
- `src/context/custom-auth-context.tsx`
- `src/app/api/auth/login/route.ts`
- `src/lib/schema.sql`
- `src/lib/setup.sql`

### **3. å®‰å…¨åŠ å›º**
è€ƒè™‘åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼š
- å¯†ç å“ˆå¸Œå­˜å‚¨ (æ›¿æ¢ `password_plain`)
- JWT ä»¤ç‰Œè®¤è¯
- æ›´ä¸¥æ ¼çš„ä¼šè¯ç®¡ç†

## ğŸ“‹ **æµ‹è¯•æ¸…å•**

### **åŠŸèƒ½æµ‹è¯•**:
- âœ… ç®¡ç†å‘˜ç™»å½•: `adminsrf` / `admin8888`
- âœ… ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
- âœ… ç”¨æˆ·ç™»å½•åŠŸèƒ½
- âœ… é€€å‡ºç™»å½•åŠŸèƒ½
- âœ… ä¼šè¯ç®¡ç† (24å°æ—¶è¿‡æœŸ)

### **å®‰å…¨æµ‹è¯•**:
- âœ… æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—®å—ä¿æŠ¤é¡µé¢
- âœ… æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†å‘˜é¡µé¢
- âœ… ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- âœ… ä¼šè¯è¿‡æœŸåè‡ªåŠ¨é‡å®šå‘

## âœ… **å®¡æŸ¥ç»“è®º**

### **ä¸»è¦æˆå°±**:
1. **å®Œå…¨ç§»é™¤äº† Supabase Auth ä¾èµ–**
2. **ç»Ÿä¸€äº†è®¤è¯ç³»ç»Ÿä¸ºè‡ªå®šä¹‰è®¤è¯**
3. **ç¦ç”¨äº†æ‰€æœ‰å†²çªçš„ RLS ç­–ç•¥**
4. **æ ‡è®°äº†éœ€è¦æ›´æ–°çš„ API è·¯ç”±**

### **ç³»ç»ŸçŠ¶æ€**: ğŸŸ¢ **å¯ç”¨äºç”Ÿäº§**
- æ ¸å¿ƒè®¤è¯åŠŸèƒ½å®Œå…¨æ­£å¸¸
- æ•°æ®åº“å±‚é¢å®Œå…¨å…¼å®¹
- åº”ç”¨å±‚é¢ç»Ÿä¸€ä½¿ç”¨è‡ªå®šä¹‰è®¤è¯
- å®‰å…¨æ§åˆ¶è½¬ç§»åˆ°åº”ç”¨å±‚

### **å»ºè®®**:
1. åœ¨ç”Ÿäº§éƒ¨ç½²å‰æµ‹è¯•æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
2. è€ƒè™‘å®æ–½å¯†ç å“ˆå¸Œå­˜å‚¨
3. ç›‘æ§åº”ç”¨å±‚å®‰å…¨æ§åˆ¶çš„æœ‰æ•ˆæ€§
4. å®šæœŸå®¡æŸ¥ç”¨æˆ·æƒé™å’Œè®¿é—®æ—¥å¿—

## ğŸ‰ **å®¡æŸ¥çŠ¶æ€: å®Œæˆ**

é¡¹ç›®å·²æˆåŠŸä»æ··åˆè®¤è¯ç³»ç»Ÿè¿ç§»åˆ°çº¯è‡ªå®šä¹‰è®¤è¯ç³»ç»Ÿï¼